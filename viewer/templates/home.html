{% load static %}

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Headspace: A Concussion Experience</title>

  <!-- Favicon -->
  <link rel="icon" href="{% static 'images/icon.ico' %}" type="image/x-icon">

  <!-- Pannellum CSS -->
  <link rel="stylesheet" href="https://unpkg.com/pannellum/build/pannellum.css"/>

  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #panorama { width: 100vw; height: 100vh; }

    /* INTRO SCREEN */
    .intro-screen {
      position: fixed;
      inset: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      background: rgba(0,0,0,0.85);
      color: white;
      z-index: 2000;
    }
    .intro-screen.hidden { display: none; }
    .intro-content { text-align: center; max-width: 600px; }
    #startBtn { padding: 12px 24px; font-size: 1.2rem; margin-top: 20px; cursor: pointer; }

    /* INTRO NARRATIVE OVERLAY */
    #intro-narrative {
      position: fixed;
      top: 10%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.5);
      color: white;
      padding: 16px 24px;
      border-radius: 10px;
      font-size: 1.5rem;
      max-width: 80vw;
      text-align: center;
      z-index: 1500;
      transition: opacity 1s;
    }

    /* CONTROLS */
    #controls {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1600; /* above intro narrative */
      display: flex;
      gap: 10px;
    }

    button {
      background: rgba(0,0,0,0.6);
      color: #fff;
      border: none;
      padding: 10px 15px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      backdrop-filter: blur(4px);
    }
    button:hover { background: rgba(0,0,0,0.85); }

    /* FADE LAYER */
    #fade {
      position: fixed;
      inset: 0;
      background: black;
      opacity: 0;
      pointer-events: none;
      transition: opacity 1s ease;
      z-index: 3000;
    }

    /* NARRATIVE BOX */
    #narrative {
      position: fixed;
      bottom: 15%;
      left: 50%;
      transform: translateX(-50%);
      color: white;
      font-size: 1.7rem;
      background: rgba(0,0,0,0.5);
      padding: 16px 24px;
      border-radius: 10px;
      opacity: 0;
      transition: opacity 1s;
      z-index: 2500;
      max-width: 80vw;
      text-align: center;
    }

    /* SCREEN SHAKE */
    .shake {
      animation: shakeAnim 0.6s ease-in-out;
    }
    @keyframes shakeAnim {
      0% { transform: translate(0px, 0px); }
      20% { transform: translate(-10px, 5px); }
      40% { transform: translate(12px, -8px); }
      60% { transform: translate(-8px, 12px); }
      80% { transform: translate(5px, -12px); }
      100% { transform: translate(0px, 0px); }
    }

    /* HOTSPOT STYLES */
    .hotspot-info {
      background: rgba(0,0,0,0.6);
      padding: 6px 10px;
      border-radius: 6px;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }
    .hotspot-info.visited {
      opacity: 0.6;
      pointer-events: none;
    }

    .pulse-icon {
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.3); opacity: 0.6; }
      100% { transform: scale(1); opacity: 1; }
    }

    /* NEXT BUTTON */
    #nextBtn.hidden { display: none; }
  </style>
</head>

<body>

<!-- Intro / Title Card -->
<div id="intro-screen" class="intro-screen">
  <div class="intro-content">
    <h1>Headspace: A Concussion Experience</h1>
    <p>Step into the shoes of a player experiencing a concussion. Explore the moments before and after a collision in this immersive 360° learning experience.</p>
    <button id="startBtn">Begin</button>
  </div>
</div>

<!-- Intro Narrative Overlay -->
<div id="intro-narrative">
  <p>Players are practicing Ultimate Frisbee in the field house. They are focused on the game, unaware that a collision is about to happen.</p>
</div>

<!-- Fade overlay -->
<div id="fade"></div>

<!-- Narrative box -->
<div id="narrative"></div>

<!-- Next button -->
<div id="controls">
  <button id="nextBtn" class="hidden" onclick="loadScene('emptyField')">Next</button>
</div>

<!-- Panorama Container -->
<div id="panorama"></div>

<!-- Pannellum JS -->
<script src="https://unpkg.com/pannellum/build/pannellum.js"></script>

<script>
  /* AUDIO */
  const scene1Audio = new Audio("{% static 'audio/ambience.mp3' %}");
  scene1Audio.loop = true;

  const scene2Audio = new Audio("{% static 'audio/ringing.mp3' %}");
  scene2Audio.loop = false;

  const impactSFX = new Audio("{% static 'audio/impact.mp3' %}");
  impactSFX.loop = false;

  function stopAllAudio() {
    scene1Audio.pause(); scene1Audio.currentTime = 0;
    scene2Audio.pause(); scene2Audio.currentTime = 0;
    impactSFX.pause(); impactSFX.currentTime = 0;
  }

  document.getElementById('startBtn').addEventListener('click', () => {
    document.getElementById('intro-screen').classList.add('hidden');
    scene1Audio.play();
    // fade out intro narrative after 5 seconds
    setTimeout(() => {
      document.getElementById('intro-narrative').style.opacity = 0;
    }, 5000);
  });

  /* PANNELLUM VIEWER */
  let visitedHotspots = 0;
  let totalHotspots = 0;

  const viewer = pannellum.viewer('panorama', {
    type: "equirectangular",
    autoLoad: true,
    default: { firstScene: "playersField", author: "Group 4" },
    scenes: {
      playersField: {
        title: "Players on Field",
        panorama: "{% static 'images/scene1.png' %}?v=2",
        hotSpots: [
          { pitch: -5, yaw: 0, type: "info",
            createTooltipFunc: hotspotTooltip,
            createTooltipArgs: {
              sceneId: "playersField",
              narrativeText: "You are concentrating hard on the frisbee..."
            }
          },
          { pitch: -10, yaw: -50, type: "info",
            createTooltipFunc: hotspotTooltip,
            createTooltipArgs: {
              sceneId: "playersField",
              narrativeText: "Another player rushes across the field, about to collide..."
            }
          }
        ]
      },
      emptyField: {
        title: "Empty Field",
        panorama: "{% static 'images/scene2.png' %}?v=2",
        hotSpots: [
          { pitch: -3, yaw: 45, type: "info",
            createTooltipFunc: hotspotTooltip,
            createTooltipArgs: {
              text: "Try to stand up",
              sceneId: "emptyField",
              narrativeText: "Your vision spins as you try to stand..."
            },
            clickHandlerFunc: () => { screenShake(); }
          },
          { pitch: -5, yaw: -30, type: "info",
            createTooltipFunc: hotspotTooltip,
            createTooltipArgs: {
              text: "Call for help",
              sceneId: "emptyField",
              narrativeText: "Your teammate notices and runs toward you..."
            }
          },
          { pitch: -8, yaw: 110, type: "info",
            createTooltipFunc: hotspotTooltip,
            createTooltipArgs: {
              text: "Assess symptoms",
              sceneId: "emptyField",
              narrativeText: "You feel dizzy, nauseous, and disoriented."
            }
          }
        ]
      }
    }
  });

  // Update totalHotspots safely after scene load
  viewer.on('load', function() {
    const currentSceneId = viewer.getScene();
    const scene = viewer.getConfig().scenes[currentSceneId];
    totalHotspots = scene.hotSpots.length;
    visitedHotspots = 0;
    document.getElementById('nextBtn').classList.add('hidden');
  });

  function hotspotTooltip(div, args) {
    div.classList.add('hotspot-info');
    div.innerHTML = `<span class="pulse-icon">⚠</span>`;

    div.addEventListener('click', () => {
      if (!div.classList.contains('visited')) {
        div.classList.add('visited');
        visitedHotspots++;
        checkAllHotspotsVisited();
        // Show narrative text if defined
        if (args.narrativeText) {
          showNarrative(args.narrativeText);
        }
      }
    });
  }

  function checkAllHotspotsVisited() {
    if (visitedHotspots >= totalHotspots) {
      document.getElementById('nextBtn').classList.remove('hidden');
    }
  }

  function showNarrative(text, duration = 3000) {
    const box = document.getElementById("narrative");
    box.innerHTML = text;
    box.style.opacity = 1;
    setTimeout(() => { box.style.opacity = 0; }, duration);
  }

  function fadeOut(callback) {
    const f = document.getElementById("fade");
    f.style.opacity = 1;
    setTimeout(() => { if (callback) callback(); }, 1000);
  }

  function fadeIn() {
    const f = document.getElementById("fade");
    f.style.opacity = 0;
  }

  function screenShake() {
    const pano = document.getElementById("panorama");
    pano.classList.add("shake");
    setTimeout(() => pano.classList.remove("shake"), 700);
  }

  function loadScene(sceneId) {
    visitedHotspots = 0;
    document.getElementById('nextBtn').classList.add('hidden');

    fadeOut(() => {
      viewer.loadScene(sceneId);
      stopAllAudio();

      if (sceneId === "playersField") {
        scene1Audio.play();
        fadeIn();
      }

      if (sceneId === "emptyField") {
        impactSFX.play();
        showNarrative("Everything goes silent...");
        impactSFX.onended = () => {
          screenShake();
          scene2Audio.play();
          showNarrative("You wake up alone on the field...");
        };
        setTimeout(() => fadeIn(), 600);
      }
    });
  }
</script>
</body>
</html>
